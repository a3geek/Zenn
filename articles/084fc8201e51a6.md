---
title: "Socket.ReceiveAsyncã¨CancellationToken"
emoji: "ğŸŒ"
type: "tech"
topics:
  - "unity"
  - "C#"
published: true
published_at: "2020-12-10 21:05"
---

Socketã‚¯ãƒ©ã‚¹ã§éåŒæœŸã«ãƒ‘ã‚±ãƒƒãƒˆã‚’å—ä¿¡ã™ã‚‹æ–¹æ³•ã¨ã—ã¦`ReceiveAsync`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãªæ‰‹æ³•ã®ä¸€ã¤ã§ã™ã€‚
ã“ã®ã¨ãã€å—ä¿¡å‡¦ç†ã‚’ã„ã¤ã§ã‚‚ä¸­æ–­ã§ãã‚‹ã‚ˆã†ã«`CancellationToken`ã‚’æ¸¡ã—ã¦ãŠãæ–¹ãŒå¥½ã¾ã—ã„ã§ã—ã‚‡ã†ã€‚
```cs
private async ValueTask ReceiveAsync(CancellationToken token)
{
    var buffer = new Memory<byte>(new byte[1024]);
    var socket = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);
    socket.Bind(new IPEndPoint(IPAddress.Any, 1234));

    while (!token.IsCancellationRequested)
    {
        var result = await socket.ReceiveAsync(buffer, SocketFlags.None, token).ConfigureAwait(false);
        if (token.IsCancellationRequested || result <= 0)
        {
            continue;
        }
        
        // received packet.
    }
}
```
