---
title: "Socket.ReceiveAsyncとCancellationToken"
emoji: "🌐"
type: "tech"
topics:
  - "unity"
  - "C#"
published: true
published_at: "2020-12-10 21:05"
---

Socketクラスで非同期にパケットを受信する方法として`ReceiveAsync`メソッドはスタンダードな手法の一つです。
このとき、受信処理をいつでも中断できるように`CancellationToken`を渡しておく方が好ましいでしょう。
```cs
private async ValueTask ReceiveAsync(CancellationToken token)
{
    var buffer = new Memory<byte>(new byte[1024]);
    var socket = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);
    socket.Bind(new IPEndPoint(IPAddress.Any, 1234));

    while (!token.IsCancellationRequested)
    {
        var result = await socket.ReceiveAsync(buffer, SocketFlags.None, token).ConfigureAwait(false);
        if (token.IsCancellationRequested || result <= 0)
        {
            continue;
        }
        
        // received packet.
    }
}
```
